<!DOCTYPE html>
<html>
<head>
  <title>YOLO for Speed and Plates Detection</title>
</head>

<body>

<h2>Detección de placas de automóvil usando YOLO</h2>

<label for="cameraSelect">Selecciona cámara:</label>
<select id="cameraSelect"></select>

<br><br>

<video id="video" autoplay playsinline style="width:100%;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const cameraSelect = document.getElementById("cameraSelect");

    let currentStream = null;

    // Obtiene todas las cámaras disponibles
    async function getCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");

        cameraSelect.innerHTML = "";

        videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Cámara ${index + 1}`;
            cameraSelect.appendChild(option);
        });
    }

    // Inicia el stream con una cámara específica
    async function startCamera(deviceId = null) {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true
        };

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
    }

    // Cuando el usuario selecciona otra cámara
    cameraSelect.addEventListener("change", () => {
        startCamera(cameraSelect.value);
    });

    // Enviar frame al backend
    async function sendFrame() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));

        let formData = new FormData();
        formData.append("frame", blob, "frame.jpg");

        try {
            const res = await fetch("https://jill-arabinosic-karolyn.ngrok-free.dev/frame", {
                method: "POST",
                body: formData
            });

            if (!res.ok) {
                const text = await res.text();
                console.error("Error HTTP:", res.status, text);
            } else {
                const data = await res.json();
                console.log("Respuesta backend:", data); 
            }

        } catch (err) {
            console.error("Error enviando frame o procesando respuesta:", err);
        }

        requestAnimationFrame(sendFrame);
    }

    // Inicializa
    async function init() {
        await getCameras();
        await startCamera(cameraSelect.value);
    }

    video.onplaying = () => sendFrame();

    init();
</script>

</body>
</html>
